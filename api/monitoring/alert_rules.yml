groups:
  - name: anythingllm-api-alerts
    rules:
      # High error rate
      - alert: HighErrorRate
        expr: rate(http_requests_total{job="anythingllm-api",status=~"5.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
          service: anythingllm-api
        annotations:
          summary: "High error rate detected"
          description: "AnythingLLM API is experiencing high error rate ({{ $value }} errors/sec)"

      # High response time
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="anythingllm-api"}[5m])) > 5
        for: 5m
        labels:
          severity: warning
          service: anythingllm-api
        annotations:
          summary: "High response time detected"
          description: "AnythingLLM API 95th percentile response time is {{ $value }}s"

      # Service down
      - alert: ServiceDown
        expr: up{job="anythingllm-api"} == 0
        for: 1m
        labels:
          severity: critical
          service: anythingllm-api
        annotations:
          summary: "AnythingLLM API service is down"
          description: "AnythingLLM API service has been down for more than 1 minute"

      # High memory usage
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes{job="anythingllm-api"} / 1024 / 1024 > 500
        for: 10m
        labels:
          severity: warning
          service: anythingllm-api
        annotations:
          summary: "High memory usage"
          description: "AnythingLLM API memory usage is {{ $value }}MB"

      # High CPU usage
      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total{job="anythingllm-api"}[5m]) > 0.8
        for: 10m
        labels:
          severity: warning
          service: anythingllm-api
        annotations:
          summary: "High CPU usage"
          description: "AnythingLLM API CPU usage is {{ $value | humanizePercentage }}"

      # Too many active jobs
      - alert: TooManyActiveJobs
        expr: anythingllm_active_jobs{job="anythingllm-api"} > 50
        for: 5m
        labels:
          severity: warning
          service: anythingllm-api
        annotations:
          summary: "Too many active jobs"
          description: "AnythingLLM API has {{ $value }} active jobs"

      # Database connection issues
      - alert: DatabaseConnectionError
        expr: anythingllm_database_connections_failed_total{job="anythingllm-api"} > 0
        for: 1m
        labels:
          severity: critical
          service: anythingllm-api
        annotations:
          summary: "Database connection errors"
          description: "AnythingLLM API is experiencing database connection errors"

      # External service (AnythingLLM) down
      - alert: AnythingLLMServiceDown
        expr: anythingllm_external_service_health{service="anythingllm"} == 0
        for: 2m
        labels:
          severity: critical
          service: anythingllm-api
        annotations:
          summary: "AnythingLLM external service is down"
          description: "AnythingLLM external service is not responding"

      # Disk space low
      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 10
        for: 5m
        labels:
          severity: warning
          service: anythingllm-api
        annotations:
          summary: "Low disk space"
          description: "Disk space is below 10% ({{ $value | humanizePercentage }} remaining)"

  - name: infrastructure-alerts
    rules:
      # PostgreSQL down
      - alert: PostgreSQLDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
          service: postgresql
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL database is not responding"

      # Redis down
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "Redis is down"
          description: "Redis cache service is not responding"

      # High database connections
      - alert: HighDatabaseConnections
        expr: pg_stat_activity_count{job="postgres"} > 80
        for: 5m
        labels:
          severity: warning
          service: postgresql
        annotations:
          summary: "High database connections"
          description: "PostgreSQL has {{ $value }} active connections"